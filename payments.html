<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Casino - Вывод средств</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .withdraw-page {
            background: linear-gradient(135deg, #f8fbff 0%, #f0f7ff 100%);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(42, 171, 238, 0.15);
        }

        .withdraw-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .withdraw-icon {
            width: 24px;
            height: 24px;
            background: #2aabee;
            mask: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%232aabee" d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14zm-6-7h3v-2h-3V8l-4 4 4 4v-3z"/></svg>') no-repeat center;
            mask-size: contain;
        }

        .withdraw-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .withdraw-info {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #e6f4ff;
            box-shadow: 0 4px 12px rgba(42, 171, 238, 0.1);
        }

        .withdraw-balance {
            font-size: 32px;
            font-weight: 800;
            color: #4CAF50;
            text-align: center;
            margin-bottom: 8px;
        }

        .withdraw-label {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .withdraw-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .form-input {
            padding: 16px;
            border: 2px solid #e6f4ff;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2aabee;
            box-shadow: 0 0 0 3px rgba(42, 171, 238, 0.1);
        }

        .withdraw-amounts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .withdraw-amount-btn {
            background: white;
            border: 2px solid #e6f4ff;
            border-radius: 12px;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #2aabee;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .withdraw-amount-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 171, 238, 0.2);
            border-color: #2aabee;
        }

        .withdraw-amount-btn.active {
            background: linear-gradient(135deg, #2aabee 0%, #229ed9 100%);
            border-color: #2aabee;
            color: white;
            box-shadow: 0 4px 12px rgba(42, 171, 238, 0.3);
        }

        .withdraw-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .withdraw-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .withdraw-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .withdraw-note {
            background: #fff8e1;
            border: 1px solid #ffd54f;
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
            font-size: 14px;
            color: #5d4037;
        }

        .withdraw-note strong {
            color: #d84315;
        }

        .withdraw-history {
            margin-top: 32px;
        }

        .withdraw-history-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .withdraw-history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .withdraw-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e6f4ff;
        }

        .withdraw-history-amount {
            font-weight: 600;
            font-size: 16px;
            color: #ff6b6b;
        }

        .withdraw-history-date {
            font-size: 14px;
            color: #666;
        }

        .withdraw-history-status {
            font-size: 14px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .withdraw-history-status.pending {
            background: rgba(255, 193, 7, 0.1);
            color: #ff9800;
        }

        .withdraw-history-status.completed {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }

        .withdraw-history-status.rejected {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        .empty-stats {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        /* Модальное окно депозита */
        .deposit-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border: 2px solid #e6f4ff;
            box-shadow: 0 4px 12px rgba(42, 171, 238, 0.1);
        }

        .deposit-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1a1a1a;
            text-align: center;
        }

        .wallet-info {
            background: #f8fbff;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .deposit-amounts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .amount-button {
            background: white;
            border: 2px solid #e6f4ff;
            border-radius: 16px;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            color: #2aabee;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .amount-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 171, 238, 0.2);
            border-color: #2aabee;
        }

        .amount-button.active {
            background: linear-gradient(135deg, #2aabee 0%, #229ed9 100%);
            border-color: #2aabee;
            color: white;
            box-shadow: 0 6px 20px rgba(42, 171, 238, 0.3);
        }

        .send-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .deposit-icon {
            width: 20px;
            height: 20px;
            background: white;
            mask: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>') no-repeat center;
            mask-size: contain;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .withdraw-amounts,
            .deposit-amounts {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .withdraw-amount-btn,
            .amount-button {
                padding: 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-panel">
            <button class="back-button" onclick="window.location.href='index.html'">
                <span class="back-icon"></span>
                Назад
            </button>
            <div class="balance-btn" onclick="window.location.href='payments.html'">
                <span class="balance-icon"></span>
                <span id="balanceAmount">1500 TON</span>
            </div>
        </div>

        <div class="content">
            <div class="withdraw-page">
                <!-- Секция пополнения -->
                <div class="deposit-section">
                    <div class="deposit-title">Пополнение баланса</div>
                    
                    <div id="tonconnect-button"></div>
                    
                    <div class="wallet-info" id="walletInfo" style="display: none;">
                        <p><strong>Кошелёк подключен:</strong></p>
                        <p id="walletAddress" style="margin-top: 8px; font-size: 12px; color: #666;"></p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div style="font-weight: 600; margin-bottom: 12px;">Сумма пополнения (TON):</div>
                        <input type="number" 
                               class="form-input" 
                               id="customDepositAmount" 
                               placeholder="Введите сумму" 
                               min="0.1" 
                               step="0.1"
                               value="1"
                               style="width: 100%; padding: 16px; font-size: 16px;">
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">
                            Минимальная сумма: 0.1 TON
                        </div>
                    </div>
                    
                    <button class="send-button" id="sendDeposit" disabled>
                        <span class="deposit-icon"></span>
                        Отправить <span id="selectedAmount">1</span> TON
                    </button>
                </div>

                <!-- Секция вывода -->
                <div class="withdraw-info">
                    <div class="withdraw-balance" id="withdrawBalance">1,500 TON</div>
                    <div class="withdraw-label">Доступно для вывода</div>

                    <div class="withdraw-form">
                        <div class="form-group">
                            <label class="form-label">Сумма вывода (TON)</label>
                            <input type="number" class="form-input" id="withdrawAmount" placeholder="Введите сумму" min="10" value="100">
                            
                            <div class="withdraw-amounts">
                                <button class="withdraw-amount-btn" data-amount="50">50 TON</button>
                                <button class="withdraw-amount-btn" data-amount="100">100 TON</button>
                                <button class="withdraw-amount-btn" data-amount="250">250 TON</button>
                                <button class="withdraw-amount-btn active" data-amount="500">500 TON</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Адрес TON кошелька</label>
                            <input type="text" class="form-input" id="withdrawAddress" placeholder="UQ... или EQ...">
                        </div>

                        <button class="withdraw-button" id="requestWithdraw">
                            Запросить вывод
                        </button>
                    </div>
                </div>

                <div class="withdraw-note">
                    <strong>⚠️ Внимание:</strong> Вывод средств обрабатывается вручную администрацией. 
                    Минимальная сумма вывода: 10 TON. Комиссия: 5%. 
                    Обычное время обработки: 1-24 часа.
                </div>

                <div class="withdraw-history">
                    <div class="withdraw-history-title">История выводов</div>
                    <div class="withdraw-history-list" id="withdrawHistoryList">
                        <!-- История выводов будет здесь -->
                    </div>
                    <div class="empty-stats" id="emptyWithdrawHistory">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            История выводов пока пуста
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item" onclick="window.location.href='index.html'">
                <div class="nav-icon game"></div>
                <div>Главная</div>
            </div>
            <div class="nav-item" onclick="window.location.href='stats.html'">
                <div class="nav-icon stats"></div>
                <div>Статистика</div>
            </div>
            <div class="nav-item active" onclick="window.location.href='payments.html'">
                <div class="nav-icon withdraw"></div>
                <div>Вывод</div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // ==================== ПЕРЕМЕННЫЕ ====================
        let currentWithdrawAmount = 500;
        let currentDepositAmount = 1;
        let tonConnectUI = null;
        let isWalletConnected = false;
        let connectedWalletAddress = null;

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        function init() {
            updateBalanceDisplay();
            initWithdrawPage();
            initTonConnect();
            
            // Инициализация аватара
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar && userAvatar.innerHTML === '') {
                userAvatar.innerHTML = '<div style="position: absolute; width: 100%; height: 100%; background: white; mask: url(\'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>\') no-repeat center; mask-size: 24px;"></div>';
            }
        }

        function updateBalanceDisplay() {
            const balance = window.getBalance();
            document.getElementById('balanceAmount').textContent = balance + ' TON';
            document.getElementById('withdrawBalance').textContent = balance + ' TON';
            document.getElementById('withdrawAmount').max = balance;
        }

        // ==================== TON CONNECT ====================
        function initTonConnect() {
            const manifestUrl = window.location.origin + '/tonconnect-manifest.json';
            
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: manifestUrl,
                buttonRootId: 'tonconnect-button',
                actionsConfiguration: {
                    twaReturnUrl: 'https://t.me/DiceCasinoBot'
                }
            });
            
            tonConnectUI.onStatusChange(wallet => {
                if (wallet) {
                    isWalletConnected = true;
                    connectedWalletAddress = wallet.account.address;
                    onWalletConnected(wallet.account.address);
                } else {
                    isWalletConnected = false;
                    connectedWalletAddress = null;
                    document.getElementById('walletInfo').style.display = 'none';
                    document.getElementById('sendDeposit').disabled = true;
                    document.getElementById('sendDeposit').innerHTML = '<span class="deposit-icon"></span>Подключите кошелёк';
                }
            });
        }

        function onWalletConnected(address) {
            document.getElementById('walletInfo').style.display = 'block';
            document.getElementById('walletAddress').textContent = window.shortenAddress(address);
            document.getElementById('sendDeposit').disabled = false;
            document.getElementById('sendDeposit').innerHTML = `<span class="deposit-icon"></span>Отправить ${currentDepositAmount} TON`;
        }

        // ==================== ПОПОЛНЕНИЕ БАЛАНСА ====================
        document.getElementById('customDepositAmount').addEventListener('input', () => {
            let value = parseFloat(document.getElementById('customDepositAmount').value) || 0.1;
            
            if (value < 0.1) {
                value = 0.1;
                document.getElementById('customDepositAmount').value = value;
            }
            
            value = Math.round(value * 10) / 10;
            document.getElementById('customDepositAmount').value = value;
            
            currentDepositAmount = value;
            document.getElementById('selectedAmount').textContent = currentDepositAmount;
            
            if (isWalletConnected) {
                document.getElementById('sendDeposit').innerHTML = `<span class="deposit-icon"></span>Отправить ${currentDepositAmount} TON`;
            }
        });

        document.getElementById('sendDeposit').addEventListener('click', async () => {
            if (!isWalletConnected) {
                window.showNotification('Сначала подключите кошелёк', 'info');
                return;
            }
            
            let depositAmount = parseFloat(document.getElementById('customDepositAmount').value) || 0.1;
            
            if (depositAmount < 0.1) {
                window.showNotification('Минимальная сумма пополнения: 0.1 TON', 'lose');
                return;
            }
            
            depositAmount = Math.round(depositAmount * 10) / 10;
            
            const originalText = document.getElementById('sendDeposit').innerHTML;
            document.getElementById('sendDeposit').innerHTML = '<span class="loading"></span>Подготовка...';
            document.getElementById('sendDeposit').disabled = true;
            
            try {
                window.showNotification('Подготовка транзакции...', 'info');
                
                // Конвертация TON → наноТОН
                const amountInNano = Math.round(depositAmount * 1000000000);
                
                if (amountInNano < 50000000) {
                    throw new Error('Сумма слишком мала для транзакции');
                }
                
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [
                        {
                            address: 'UQBKY-FkAwXlWkaZ9bNunXkGO5iChsGLyeTHhjIVthgFXwUh',
                            amount: amountInNano.toString(),
                            payload: ''
                        }
                    ]
                };
                
                window.showNotification('Подтвердите транзакцию в кошельке...', 'info');
                
                const result = await tonConnectUI.sendTransaction(transaction);
                
                console.log('Транзакция успешна:', result);
                
                setTimeout(() => {
                    window.updateBalance(depositAmount);
                    updateBalanceDisplay();
                    window.showNotification(`✅ Баланс пополнен на ${depositAmount} TON!`, 'info');
                    
                    document.getElementById('customDepositAmount').value = "1";
                    document.getElementById('selectedAmount').textContent = "1";
                    
                }, 2000);
                
            } catch (error) {
                console.error('Ошибка транзакции:', error);
                
                let errorMessage = 'Транзакция отменена';
                
                if (error.message.includes('User rejected')) {
                    errorMessage = 'Вы отменили транзакцию в кошельке';
                } else if (error.message.includes('insufficient balance')) {
                    errorMessage = 'Недостаточно средств в кошельке';
                } else if (error.message.includes('Сумма слишком мала')) {
                    errorMessage = 'Минимальная сумма: 0.1 TON';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Ошибка сети. Проверьте интернет';
                }
                
                window.showNotification(`❌ ${errorMessage}`, 'lose');
                
            } finally {
                document.getElementById('sendDeposit').innerHTML = originalText;
                document.getElementById('sendDeposit').disabled = false;
            }
        });

        // ==================== ВЫВОД СРЕДСТВ ====================
        function initWithdrawPage() {
            document.getElementById('withdrawBalance').textContent = window.getBalance() + ' TON';
            document.getElementById('withdrawAmount').max = window.getBalance();
            
            document.querySelectorAll('.withdraw-amount-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.withdraw-amount-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentWithdrawAmount = parseInt(btn.dataset.amount);
                    
                    if (currentWithdrawAmount > window.getBalance()) {
                        currentWithdrawAmount = window.getBalance();
                    }
                    
                    document.getElementById('withdrawAmount').value = currentWithdrawAmount;
                });
            });
            
            document.getElementById('withdrawAmount').addEventListener('input', () => {
                const amount = parseInt(document.getElementById('withdrawAmount').value) || 0;
                
                if (amount < 10) {
                    document.getElementById('withdrawAmount').value = 10;
                } else if (amount > window.getBalance()) {
                    document.getElementById('withdrawAmount').value = window.getBalance();
                }
                
                let hasActive = false;
                document.querySelectorAll('.withdraw-amount-btn').forEach(btn => {
                    if (parseInt(btn.dataset.amount) === parseInt(document.getElementById('withdrawAmount').value)) {
                        btn.classList.add('active');
                        hasActive = true;
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                if (!hasActive) {
                    document.querySelectorAll('.withdraw-amount-btn').forEach(btn => btn.classList.remove('active'));
                }
            });
            
            document.getElementById('requestWithdraw').addEventListener('click', requestWithdraw);
            
            updateWithdrawHistory();
            setInterval(checkWithdrawStatus, 30000);
        }

        async function requestWithdraw() {
            const amount = parseInt(document.getElementById('withdrawAmount').value) || 0;
            const address = document.getElementById('withdrawAddress').value.trim();
            
            if (amount < 10) {
                window.showNotification('Минимальная сумма вывода: 10 TON', 'lose');
                return;
            }
            
            if (amount > window.getBalance()) {
                window.showNotification('Недостаточно средств на балансе', 'lose');
                return;
            }
            
            if (!address || (!address.startsWith('UQ') && !address.startsWith('EQ'))) {
                window.showNotification('Введите корректный TON адрес (начинается с UQ... или EQ...)', 'lose');
                return;
            }
            
            if (address.length < 48) {
                window.showNotification('Адрес слишком короткий', 'lose');
                return;
            }
            
            const originalText = document.getElementById('requestWithdraw').innerHTML;
            document.getElementById('requestWithdraw').innerHTML = '<span class="loading"></span>Обработка...';
            document.getElementById('requestWithdraw').disabled = true;
            
            try {
                window.updateBalance(-amount);
                updateBalanceDisplay();
                
                const result = await window.sendWithdrawRequest(amount, address);
                
                if (result.success) {
                    updateWithdrawHistory();
                    
                    document.getElementById('withdrawAmount').value = Math.min(100, window.getBalance());
                    document.getElementById('withdrawAddress').value = '';
                    
                    window.showNotification(`✅ Заявка #${result.id} создана!`, 'info');
                } else {
                    window.updateBalance(amount);
                    updateBalanceDisplay();
                    window.showNotification('❌ Ошибка при создании заявки', 'lose');
                }
                
            } catch (error) {
                console.error('Ошибка создания заявки:', error);
                window.showNotification('❌ Ошибка при создании заявки', 'lose');
                
                window.updateBalance(amount);
                updateBalanceDisplay();
            } finally {
                document.getElementById('requestWithdraw').innerHTML = originalText;
                document.getElementById('requestWithdraw').disabled = false;
            }
        }

        function updateWithdrawHistory() {
            const withdrawHistoryList = document.getElementById('withdrawHistoryList');
            const emptyWithdrawHistory = document.getElementById('emptyWithdrawHistory');
            
            withdrawHistoryList.innerHTML = '';
            
            const withdrawHistory = window.getWithdrawHistory();
            
            if (withdrawHistory.length === 0) {
                emptyWithdrawHistory.style.display = 'block';
                withdrawHistoryList.style.display = 'none';
                return;
            }
            
            emptyWithdrawHistory.style.display = 'none';
            withdrawHistoryList.style.display = 'flex';
            
            const sortedHistory = [...withdrawHistory].reverse();
            
            sortedHistory.forEach(withdraw => {
                const item = document.createElement('div');
                item.className = 'withdraw-history-item';
                
                const date = new Date(withdraw.timestamp).toLocaleDateString();
                const time = new Date(withdraw.timestamp).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let statusText = 'Ожидание';
                let statusClass = 'pending';
                
                if (withdraw.status === 'completed') {
                    statusText = 'Выполнен';
                    statusClass = 'completed';
                } else if (withdraw.status === 'rejected') {
                    statusText = 'Отклонен';
                    statusClass = 'rejected';
                }
                
                item.innerHTML = `
                    <div>
                        <div class="withdraw-history-amount">-${withdraw.amount} TON</div>
                        <div class="withdraw-history-date">${date} ${time}</div>
                    </div>
                    <div class="withdraw-history-status ${statusClass}">
                        ${statusText}
                    </div>
                `;
                
                withdrawHistoryList.appendChild(item);
            });
        }

        async function checkWithdrawStatus() {
            try {
                const response = await fetch(`https://api.telegram.org/bot8212269748:AAFog811LFiMRQZuAeMFZxGHOHm3rhxduQY/getUpdates?offset=-10`);
                const data = await response.json();
                
                if (data.ok && data.result) {
                    data.result.forEach(update => {
                        if (update.callback_query) {
                            const callback = update.callback_query;
                            const callbackData = callback.data;
                            
                            if (callbackData.startsWith('withdraw_approve_') || callbackData.startsWith('withdraw_reject_')) {
                                const withdrawId = callbackData.split('_')[2];
                                const status = callbackData.includes('approve') ? 'completed' : 'rejected';
                                
                                const withdrawHistory = window.getWithdrawHistory();
                                const withdrawIndex = withdrawHistory.findIndex(w => w.id == withdrawId);
                                
                                if (withdrawIndex !== -1) {
                                    withdrawHistory[withdrawIndex].status = status;
                                    localStorage.setItem('withdrawHistory', JSON.stringify(withdrawHistory));
                                    
                                    if (status === 'rejected') {
                                        window.updateBalance(withdrawHistory[withdrawIndex].amount);
                                        updateBalanceDisplay();
                                        window.showNotification(`❌ Заявка #${withdrawId} отклонена. Баланс возвращен.`, 'info');
                                    } else {
                                        window.showNotification(`✅ Заявка #${withdrawId} выплачена!`, 'info');
                                    }
                                    
                                    updateWithdrawHistory();
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Ошибка проверки статуса:', error);
            }
        }

        // ==================== ЗАПУСК ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
